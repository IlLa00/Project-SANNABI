# Project-SANNABI
C++과 WinAPI를 이용한 산나비 모작
핵심 목표는 **언리얼 엔진과 비슷하게 구조를 설계**하고 **물리 엔진 직접 구현.**

에셋은 **AssetStudio**를 활용해 실제 게임의 에셋 추출을 진행.

- 무슨 기능이 메인인가?
    - **물리 엔진** 구현.
    - 최대한 **언리얼 엔진과 비슷하게 동작**.
    - 애니메이션을 다루는 **애니메이터** 구현.
- 서브로 무슨 기능을 넣을까?
    - **원작의 4챕터에선, 플레이어 캐릭터를 바꿀 수 있다..**
- 추가로 넣어볼만한 기능은?
    
    FMOD 사운드 도입.
    
- **킥 오프**
    
    **발표 자료 : [산나비 모작 | Gamma](https://gamma.app/docs/-v8mf4vmas8y9a68?mode=doc)**
    
    - 0주차
        - 사용할 스프라이트 선별.
        - 클래스 다이어그램 작성.
    - 1주차
        - 컴포넌트 기반 아키텍처 초기 형태 구현.
        - 스프라이트 애니메이션 관련 시스템 구축.
        - 플레이어 캐릭터 기본 이동(점프 포함) 구현.
        - 타일맵?
    - 2주차
        - 충돌 처리(최소 지면감지).
        - 사슬팔 부착 및 끌어당기기.
        - 사슬팔 스윙.
        - 사슬팔 시각화.
    - 3주차
        - 물리엔진 마무리.
        - 적군 구현
        - UI
        - 간단한 레벨 디자인
    - 4주차
        - 디버깅
        - 사운드 추가
- **중간 발표**
    
    **발표 자료 :** https://gamma.app/docs/-1wgarq5qkgb4hqd?mode=doc
    

---

- **1주차 진행**
    - 컴포넌트 기반 아키텍처 초기 형태 구현.
    - 스프라이트 애니메이션 관련 시스템 구축.
    - 플레이어 캐릭터 기본 이동(점프 포함) 구현.
    - 타일맵? ← 2주차 후반부부터 진행할듯. 우선순위는 물리와 충돌!
    
    - **1일차. 07.30**
        
        <aside>
        💡
        
        **미래의 내가 스프라이트 노가다를 해줄꺼야..**
        
        </aside>
        
        - 전반적인 초기 아키텍처 구현.
        - 캐릭터 왼쪽,오른쪽(A,D) 이동 구현.
        - **애니메이션 관련 클래스 구현**.
            - 하지만, 스프라이트 크기 이슈로 달리는 모션이 다음 모션까지 나봐버리는 에러 발생.
                - 노가다로 크기 조절해야 할지도..
            - 애니메이션 자체는 정상적으로 동작되나, 애니메이션 자체 크기가 너무 커버림.
                - 따로 scale 변수를 둠으로써 해결.
        
    - **2일차. 07.31**
        
        <aside>
        💡
        
        **생각보다 1주차 계획이 금방 끝나버리는 것 같다! ~~이래놓고 나중에 버그터짐~~**
        
        </aside>
        
        - 스프라이트 반전 기능 구현.
        - **캐릭터 중력관련(점프) 구현.**
            - **?? position 업데이트를 actor에서 해야하나? physics에서 일괄적으로 처리해야하나??**
                - PhysicsComponent에서 일괄적으로 처리하게 함. 이유는 **게임에서 움직이는 Actor는 모두 PhysicsComponent를 가져야할 것 같아 중력에 의한 이동을 해야하니 중력을 담당하는 PhysicsComponent에서 Postion을 결정.**
        - **AABB 충돌 구현.**
    - **3일차. 08.01**
        
        <aside>
        💡
        
        **구조 설계에 대한 고민이 많은 하루였다~**
        
        </aside>
        
        - **사슬팔 부착 구현.**
            - 플레이어가 사슬팔 발사 시, 플레이어가 지면에서 떨어지는 상황 발생.
                - **사슬팔 발사체와 플레이어의 EndOverlap이 발생해서 플레이어의 중력이 꺼짐.**
                - 이를 해결하기 위해, collider에 열거형을 두어 콜라이더를 구분해 콜라이더를 무시?하는 기능 구현해 원활한 충돌처리 기대.
                - 하지만 SetIgnoreType().. 을 하는 것보단 열거형 자체에 무시할 콜라이더를 지정하는 방법이 있지않을까?
                - **언리얼 엔진처럼 껏다켰다 하는 기능을 위해 bool형 2차원배열로 구현해보았다.**
                    
                    ```cpp
                    bool bignore[(int32)ECollisionChannel::Max][(int32)ECollisionChannel::Max] = {0};
                    bool bblock[(int32)ECollisionChannel::Max] = { 0 };
                    bool boverlap[(int32)ECollisionChannel::Max] = { 0 };
                    ```
                    
        - **사슬팔 관련 중력 시스템 설계**
            - 초기 설계단계에서는 GrapplingComponent에서 관리하려고 하였으나, 현 시점 GrapplingComponent에서 GrapplingHook 객체 발사체를 관리하고 있음. **이 클래스에 과연 중력 관련 시스템을 구현하는게 옳은 것일까?**
                - 단일책임의 원칙 위배가 아닌가? 그렇지만 구현 난이도는 클래스를 새로 생성하는 것에 비해서는 확연히 낮을 것이라고 판단됨.
                - 클래스를 따로 만들어 하기에는 재사용성과 확장성이 굳이..? 싶은 느낌. 어차피 플레이어만 사용할 것이 아닌가.. 또한, 컴포넌트 통신 난이도가 비약적으로 상승할 것 같음.
                - **구조적 설계 능력을 어필한다지만, 굳이 이런 구조를 사용할 이유도 크게 와닿지 않음.**
            
    
- **2주차 진행**
    - 충돌 처리(최소 지면감지).
    - 사슬팔 부착 및 끌어당기기.
    - 사슬팔 스윙.
    - 사슬팔 시각화.
    
    - **4일차 08.05**
        
        <aside>
        💡
        
        **접선벡터에 대한 개념을 알게되었다!**
        
        </aside>
        
        - **접선벡터**
            - 간단히 말하면, 원 위의 한 점에서 **원을 따라 움직이는 방향**을 나타내는 벡터, **반지름에 수직인 벡터.**
            
            ![image.png](attachment:4c66fba0-261b-4eae-8ee9-234c4b5f42ba:image.png)
            
            ![image.png](attachment:0bfea1d7-42e0-4212-90ec-ee2e4a4a5d31:image.png)
            
            한줄 요약하면 **접선벡터 = 지금 이 순간 움직이고 있는 방향.**
            
        - **사슬팔 부착**
        - **사슬팔 끌어당기기**
    - **5일차 08.07**
        
        <aside>
        💡
        
        **충돌처리.. 참으로 머리아프다……..더 손봐야한다..**
        
        </aside>
        
        - **충돌 처리**
            - 단순히 bool값을 리턴하는 AABB 충돌이 아닌, **HitResult 구조체를 리턴**하는 함수를 만들어 **플레이어의 콜리전 위치(상하좌우)에 따른 각기 다른 충돌 처리.**
            - 머리에 부딪히면 천장에서 이동(y축이동 없음), 좌우에 부딪히면 벽타기(x축이동 없음), 땅에 부딪히면 지면 이동.
    - **6일차 08.08**
        - **PhysicsComponent와 Player 클래스 리팩토링.**
            - 변수명과 함수명, 열거형 네이밍 다시하자 헷갈려 죽겠다..
        - **물리 엔진 거의 완.**
        - **애니메이션 클래스**
        - **로비 씬 작업**
    
- **3주차 진행**
    - 물리엔진 마무리. ← 한 80~90퍼정도?
    - 적군 구현 ← 50퍼정도?
    - UI - 생각보다 할게 없는데?
    - 간단한 레벨 디자인 → 맵 에디터
    
    - **7일차 08.11**
        - 애니메이션 작업
            - 모든 이미지의 크기 - **(400,500) 반드시 이 작업부터.**
            - photoscapeX로 이미지 이어붙이기
            - 근데 배경이 투명으로 안됨..
            - 그래플 파이어 모션 필요
    - **8일차 08.12**
        - **맵 에디터 제작 시작**
            - 일단 서브윈도우를 띄우고, 타일을 메인 윈도우에 그리는 것 까진 완성.
            - 타일맵 에디터를 확장하여, 렌더링만 될 건축물과 움직이는 플랫폼 배치를 하는 등 확장하려고 했으나, 텍스처의 크기(메인 윈도우의 그리드와 맞지않음)의 이유로 확장 실패.
        - **에디터 맵 세이브 및 로드**
        - **게임씬에서 세이브한 파일 로드**
            - 근데 왜 타일 위치가 이상하지
    - **9일차 08.13**
        - 키보드 입력이 잘 먹지 않음.
            
            ```cpp
            while (msg.message != WM_QUIT)
            {
                if (::PeekMessage(&msg, NULL, 0, 0, PM_REMOVE))
                {
                    TranslateMessage(&msg);
                    DispatchMessage(&msg);
                }
                else
                {
                    ::QueryPerformanceCounter(&now);
                    float elapsed = (now.QuadPart - prev.QuadPart) / static_cast<float>(frequency.QuadPart) * 1000.0f;
            
                    if (elapsed >= targetFrameTime)
                    {
                        InputManager::GetInstance()->Update();
                        engine->Update();
                        engine->Render();
            
                        prev = now;
                    }
                }
            }
            ```
            
            - InputManager의 Update()를 프레임제한하는 조건문안에 넣었어야했다. 이전엔 밖에서 함.
        - 근데 왜 타일 위치가 이상하지?
            - Convert를 잘못했었다.. 해결!
        - 게임씬에서도 서브윈도우가 뜨네
            
            ```cpp
            ShowWindow(subWnd, false);
            UpdateWindow(subWnd);
            ```
            
            - 구문을 EditorScene의 Init()함수로 이동.
        - **어댑터 패턴**
            - “서로 호환되지 않는 인터페이스를 가진 클래스들을 함께 동작할 수 있게 해주는 패턴”
            - 현재, 게임씬에서 타일맵의 RECT형 충돌구역 데이터를 받았는데, 기존에 사용하는 CollisionComponent와 CollisionManager의 연동에 대해 고민하게됨.
            - TileMapAdapter 클래스를 만들어서 Convert를 시킨다면? 성공!
            
    - **10일차 08.14**
        - 레벨디자인
        - 애니메이션
        - 버그수정
            - 타일 충돌체 벽뚫
                - 그냥 충돌체 한개가 이상하게 생성되어있었음.. 지우니 해결.
            - 사슬팔 발사 방향 이상
                - 마우스 포지션을 월드 포지션으로 바꾸니 해결.
    - **11일차 08.15**
        - 적군 배치
            - 애니메이션을 사용하려하니, 터렛의 총구?가 회전되어야하고, 스프라이트 이미지가 본체와 총구가 분리되어 있음.
            - 총구의 회전과 발사를 담당할 액터를 따로 만들어(TurretGun)을 만들어 Turret 액터가 관리를 하는 방법 vs 그냥 총구의 렌더링을 담당하는 SpriteRenderComponent에 Vector Rotation 값을 만들어 회전시키는 방법.
            - 전자는 역할이 명확히 분리되어 유지보수성면에서 좋을 것 같으나.. 메모리를 더 잡아먹고 액터의 진짜 일부분만 사용하는데 굳이 상속받아야하나?
            - 후자는 전자에 비해서 구현이 간단?할 것 같고 메모리를 덜 잡아 먹을 것 같으나 SpriteRenderComponent를 사용하는 다른 액터들에게 문제가 생기지 않을까? 가령 회전값을 안쓰는 얘들이 영향이 갈 수도 있고 RenderComponent는 렌더링만 담당해야하지 않나.. **근데 생각리도 회전해야한다.**
            - 결국은 메모리를 더 잡아먹느냐, 단일책임의 원칙을 깨고 확장성?면에서 나쁠 것인가?
- **4주차 진행**
    - 디버깅
    - 사운드 추가
    - 적군 구현
    
    - **12일차 08.18**
        - 총알이 날라가지도, 렌더링도 안된다.
            - 총알의 업데이트와 렌더함수도 호출도 안하고 방향벡터로 사용할 변수에 normalized도 안했으니까…
        - **사슬팔을 해제할 때, 스윙하던 관성을 받아 진행하던 방향으로 자연스럽게 날아가야 하는데 그대로 수직낙하를 해버림.**
            - 수직낙하 : 사슬을 놓는 순간 Player::NoneInput()이 호출이 되는데 여기에 velocity.x=0; 코드가 있어 수평 속도를 없애버림. 즉, 스윙 관성마저 없애버림.
            - 이를 Grappling 상태일때는 호출되지 않게 가드 로직 추가함으로 속도 보존.
            - EndGrappling()에서 속도를 계산하고 있었는데, 생각해보니 UpdateGrapplePhysics()에서 계산하고 있었는데 또 해버리니 문제 발생… 이미 계산된 속도를 또 덮어씌어버림.
            - 날아가는 방향이 반대로됨. Vector tangent(cos, -sin)으로 바꿈으로 해결.
            - 잠깐! 접선벡터의 공식은 (-sin,cos)이 아니었나?
            - 표준 수학 좌표계에서는 보통 x축의 양의 방향에서부터 반시계 방향으로 측정해 이때의 접선벡터 공식은 (-sin,cos)가 맞다. 하지만 나는 atan2f(y,x)로 y좌표를 먼저 인자로 받지 않고 x좌표부터 인자값을 넣었으니 반대로 넣어야한다.
    - **13일차 08.19**
        - 공격 구현하기
        - SHIFT 만들다 말았다
        - **지금 왜 프레임이 60단위지???????어떻게 디버깅하는지 여쭤보자 - 성능프로파일러 쓰자**
            
            ![image.png](attachment:e52f1757-302d-4ed2-81f9-a722842e38f3:image.png)
            
        
        ![image.png](attachment:856c3d58-271b-4739-9d34-83e82bb132a5:image.png)
        
        - 렌더링 함수쪽에서 CPU를 많이 잡아먹는다..
        - 일단 타일맵 렌더링 쪽에서 컬링을 시도하니 나아짐 (4% 하락)
            
            ![image.png](attachment:7c59dfeb-186e-4489-a393-28ebab20fac0:image.png)
            
        - hdc를 하나 만들어 미리 그리고, 렌더함수에선 한번만 그리면된다. 라는 방식이 있다
            - 이 작업은.. 배경화면과 건축물 도입하고.
        - 충돌이 이상함. 가끔 벽뚫함.
        - 스프라이트 렌더 컴포넌트에 회전과 위치값을 따로 줘야하고 애니메이션 멈춤? 기능도 있어야함 - 개어려움 진짜
        - 모든 렌더에 레이어 순서를 매겨야함. - 일단 AddComponent() 호출한 컴포넌트 순대로 렌더링되니까 일단 이걸로해
        - 건축물 및 배경화면 배치해야함 - 했다. 서브윈도우 하나 더만들어서 건축물에디터 생성.
        - 
    - **14일차 08.20**
        - **적군 배치 포지션 타일맵 모드에 넣어야함** - 해결했쥬?
        - **최적화**
            - hdc를 하나 만들어 미리 그리고, 렌더함수에선 한번만 그리면된다. 라는 방식이 있다 -13일차
            - Init()함수에 렌더링을 한번하고 Render()함수에서 복사.
                
                ```cpp
                {
                	Vector screenPos = CameraManager::GetInstance()->ConvertScreenPos(Vector(0, 0));
                	::TransparentBlt(
                		_hdcBack,
                		screenPos.x, screenPos.y,
                		5000,
                		5000,
                		_hdcMapBack,
                		0,
                		0,
                		5000,
                		5000,
                		RGB(255, 255, 255)
                	);
                }
                ```
                
            - 배경화면을 에디터씬에서 배치하지않고 어차피 위처럼 한번만 출력하면되니까 동일한 방식으로 진행했으나.. FPS가 말도안되게 떨어짐.
            - TransparentBlt함수는 투명도 처리가 있어 느린걸로 판단되어 BitBlt쓰기로 결정.
            - TransparentBlt함수가 아닌 BitBlt로 써서 해결, 배경화면으로 쓸 이미지 자체를 늘려버림.
                
                ```cpp
                if (_BG)
                {
                	// BitBlt를 사용하여 배경을 렌더링합니다.
                	::BitBlt(_hdcBack,
                		0,
                		0,
                		GWinSizeX, // 대상 너비
                		GWinSizeY, // 대상 높이
                		_BG->_textureHdc,
                		CameraManager::GetInstance()->GetCameraPos().x, // 원본 X 좌표
                		CameraManager::GetInstance()->GetCameraPos().y, // 원본 Y 좌표
                		SRCCOPY); // 원본을 그대로 복사
                }
                ```
                
                | **함수 이름** | **주요 기능** | **장점** | **단점** |
                | --- | --- | --- | --- |
                | **BitBIt** | **원본 비트맵을 대상 영역에 1:1로 복사** | **가장 빠름, CPU 부하가 적음** | **크기 조절/투명 효과 불가능** |
                | **StretchBIt** | **원본 비트맵을 대상 영역에 맞게 확대/축소하여 복사** | **크기 조절이 가능하여 유연함** | **BitBIt보다 느림, 확대/축소 시 화질 저하 가능** |
                | **TransparenetBIt** | **특정 색상을 지정하여 투명하게 복사** | **투명 효과를 간단히 구현 가능** | **세 함수 중 가장 느림, 크기 조절 불가능** |
            
        - 그래플링 맘에 안듦 - 천천히 수정해보자
        - 공격 맘에 안듦 - 이건 상태관리 신경 제대로해야함, 일단 만들었으나 공격끝나고 점프가 안됨. 사실 점프가 아니라 에어대쉬라는걸 새로 만들면 될듯?
        - 피격만들어야한다
        - 씬 이동해야함
        - 이펙트 넣어야함
        - 스프라이트 회전..필요하다…..
    - **15일차 08.21**
        - 공격 맘에 안듦 - 이건 상태관리 신경 제대로해야함, 일단 만들었으나 공격끝나고 점프가 안됨. 사실 점프가 아니라 에어대쉬라는걸 새로 만들면 될듯?
        - 왜 플레이어 랑 불릿 충돌이 이상하지 불릿은 되는데 플레이어가 안되네.
            - 함수 바인딩에 문제가 있음, 2개를 바인딩해서 같이 호출되자는 생각으로 진행했지만.. 마지막에 바인딩한 함수가 직전에 바인딩한 함수를 덮어씌워버림. 그래서 OnGroundBeginOverlap은 되지만, OnCharacterBeginOverlap이 안됨.
        - 피격시 콜리전 컴포넌트를 꺼버리니 지형지물과 충돌을 안한다..
            - 채널 하나 더 만들어서 관리.
        - 스프라이트 기본 방향에 맞춰 렌더링 - 오른쪽으로 가다가 키를 떼면 왼쪽을 바라봄
            - 이건 해결했는데 벽탈 때 키를 떼도 계속 움직이는 이전에 터진 버그 발생.
            - 해결.. 그냥 direction값을 바꾸는 과정에서 발생함
        - 벽타는것도 반전시켜야됨
            - 위와 동일.
        - 스프라이트 회전 - 렌더링만. ← 이거 너무 생각하기 복잡함 나중에 하자
        - 씬 이동
            - 게임씬으로 이동하자마자 캐릭터가 피격을 받았는데 알고보니 오브젝트 풀에있는 객체들이랑 겹쳐서 그럼. 위치이동하고 collsiioncomponent를 onoff함으로써 해결.
        - 폰트 적용
    - **16일차 08.22**
        - 스프라이트 회전 ← 스프라이트를 바꾸고 더 디테일하게 수정해보자
            - 얘 때문에 프레임이 떨어지는 줄 알았는데 알고보니 적군이었음..
        - 공격할때 속도감
            - curve 사용 (0~1) ex. 0.2초까지는 0.3이다가 넘어선 0.8을 주는 이런 방식.
        - 에디터 - 빨간 공간 - 타일맵에서 qe누르면 스왑 / 무빙플랫폼
        - 카메라 쉐이킹
    - **17일차 08.23**
        - 사운드
            - DirectSound함수와 SoundManager로 도입.
        - 총알 텍스처 - 회전해야됨, 정적 텍스처 뒤집기..
        - 로비씬 마우스
        - 사슬팔 텍스처
            - 사슬팔 발사/그래플/감기 상태일때 체인텍스처 보일 좌표 계속 계산해 렌더링.
        - 학교에서 노트북으로 옮기니 파일의 경로가 맞지않아 몇몇 텍스처 파일을 못불러온다.
            - 절대 경로라서 상대 경로로 바꿔야하는데 노트북으로 바꾸긴 좀 무섭다.
            - 월요일에 학교가서 바꾸자.
        - 플랫폼에 사슬팔을 부착하면, 그래플 포인트 위치가 계속 갱신되어야함.
            - 피직스컴포넌트에서 grapplepoint를 startgrappling할때 지정시키는 방식이 아닌, 매프레임마다 grapple의 위치를 갱신시키는 방식으로 변경.
    - **18일차 08.24**
        - 이펙트
            - VFXManager와 VFX클래스 생성
    
- **5주차 진행**
    - **19일차 08.25**
        - 학교에서 어느정도 기술문서 작성하기, 그전에 때깔좋게..
        - 파일 절대경로 → 상대경로
        - 벽탈때 사슬팔 렌더링.
        - 이펙트 크기 줄이기
        - 전체적으로 스프라이트 회전 손보기
        - 레벨디자인
        - 이게 대체 무슨 오류여
        
        ![image.png](attachment:7358b1df-702c-4a00-b966-eb90a3c332cd:image.png)
        
    - **20일차 08.26**
    - **21일차 08.27 이땐 마무리해야한다!!!!!!!!!!!**

- **KPT 회고록**
